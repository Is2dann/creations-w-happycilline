{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.name }} - Products | Creations with Happycilline{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-md-6">
      {% if primary_image %}
        <button type="button" class="p-0 border-0 bg-transparent w-100 pointer" data-bs-toggle="modal" data-bs-target="#imageModal" data-idx="0" aria-label="Open main image of {{ product.name }}">
          <img id="mainImage" class="img-fluid rounded shadow-cwh w-100 prod-image" src="{{ primary_image.image.url }}" alt="{{ primary_image.alt_text|default:product.name }}">
        </button>
      {% else %}
        <div class="bg-light border rounded d-flex align-items-center justify-content-center h-360">
          <span class="text-muted">No Image</span>
        </div>
      {% endif %}

      {% if gallery %}
        <div class="d-flex gap-2 mt-3 flex-wrap">
          {% for img in gallery %}
            <button type="button" class="btn p-0 border-0 pointer" data-bs-toggle="modal" data-bs-target="#imageModal" data-idx="{{ forloop.counter0|add:1 }}" aria-label="Open image of {{ img.alt_text|default:product.name }}">
              <img class="img-thumbnail rounded thumbnail-image" src="{{ img.image.url }}" alt="{{ img.alt_text|default:product.name }}" loading="lazy">
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="col-md-6">
      <h1 class="h3">{{ product.name }}</h1>
      <p class="h4 mb-2">£{{ product.price|floatformat:2 }}</p>

      {% if average_rating %}
        <p class="mb-2">
          <strong>Rating:</strong>
          {{ average_rating|floatformat:1 }}/5
          {% for i in "12345" %}
              {% if forloop.counter <= average_rating %}
                <i class="fa-solid fa-star text-warning"></i>
              {% else %}
                <i class="fa-regular fa-star text-warning"></i>
              {% endif %}
          {% endfor %}
          <span class="small text-muted">
            ({{ reviews|length }} review{{ reviews|length|pluralize }})
          </span>
        </p>
      {% else %}
        <p class="mb-2 small text-muted">No reviews yet.</p>
      {% endif %}

      {% if product.description %}
        <div class="mb-3">{{ product.description|linebreaks }}</div>
      {% endif %}

      {% if user.is_authenticated %}
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <form class="d-flex gap-2 align-items-center" method="POST" action="{% url 'bag:add_to_bag' product.id %}">
          {% csrf_token %}
          <label for="id_qty" class="mb-0">Qty</label>
          <input class="form-control mw-120" type="number" name="quantity" id="id_qty" value="1" min="1">
          <input type="hidden" name="redirect_url" value="{{ request.path }}">
          <button class="btn btn-success" type="submit">Add to Bag</button>
        </form>

        <form method="post" action="{% url 'products:wishlist_toggle' product.id %}">
          {% csrf_token %}
          <input type="hidden" name="redirect_url" value="{{ request.path }}">
          <button type="submit"
                  class="btn {% if in_wishlist %}btn-cwh{% else %}btn-cwh-outline{% endif %}">
            {% if in_wishlist %}
              <i class="fa-solid fa-heart me-1"></i> In Wishlist
            {% else %}
              <i class="fa-regular fa-heart me-1"></i> Add to Wishlist
            {% endif %}
          </button>
        </form>
      </div>
      {% else %}
        <div class="d-flex flex-column flex-sm-row gap-2 mb-3">
          <a class="btn btn-secondary btn-cwh" href="{% url 'account_login' %}">Sign in/up</a>
        </div>
      {% endif %}

      {% if product.category %}
        <p class="mb-0">
          <small>Category:
            <a href="{% url 'products:category' slug=product.category.slug %}">
              {{ product.category.name }}
            </a>
          </small>
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Reviews section -->
  <div class="row mt-5">
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Customer Reviews</h2>
        {% if user.is_authenticated %}
          <a href="{% url 'products:product_review' product.slug %}" class="btn btn-sm btn-cwh-outline">
            {% if user_review %}Edit your review{% else %}Write a review{% endif %}
          </a>
        {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-sm btn-cwh-outline">
            Sign in to write a review
          </a>
        {% endif %}
      </div>

      {% if reviews %}
        <div class="vstack gap-3">
          {% for review in reviews %}
            <div class="card card-cwh p-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                  <strong>{{ review.user.first_name|default:review.user.username }}</strong>
                  <span class="small text-muted">
                    • {{ review.created_at|date:"Y-m-d" }}
                  </span>
                </div>
                <div>
                  {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}
                        <i class="fa-solid fa-star text-warning"></i>
                      {% else %}
                        <i class="fa-regular fa-star text-warning"></i>
                      {% endif %}
                  {% endfor %}
                </div>
              </div>
              {% if review.title %}
                <div class="fw-semibold">{{ review.title }}</div>
              {% endif %}
              <p class="mb-0">{{ review.body|linebreaks }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="small text-muted mb-0">There are no reviews for this product yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Full view image modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content rounded-2xl" style="background: var(--cwh-charcoal); position: relative;">
      <div class="modal-header border-0">
        <h5 class="modal-title">{{ product.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0 position-relative">
        <img id="imageModalFull" src="" alt="" class="w-100 full-modal">

        <!-- Prev/Next controls -->
        <button type="button" id="prevBtn" class="btn btn-cwh-outline position-absolute top-50 start-0 translate-middle-y ms-2" aria-label="Previous image">
          ←
        </button>
        <button type="button" id="nextBtn" class="btn btn-cwh-outline position-absolute top-50 end-0 translate-middle-y me-2" aria-label="Next image">
          →
        </button>
      </div>

      <div class="modal-footer border-0">
        <div class="small text-muted" id="imageCounter" aria-live="polite"></div>
        <button type="button" class="btn btn-cwh" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/product_detail.js' %}"></script>
{% endblock %}
